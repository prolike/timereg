{% extends 'layout.html' %}

{% block body %}
<div class = 'center-text'>
    <h1>Work time table</h1>
</div>    
<div class = 'info-section'>
    <ul>
        <li>
            User <a href = 'https://www.github.com/{{ username }}'>{{ username }}</a>
        </li>
        <li>
            Working on <a href = '{{ url }}'>{{ url }}</a>
        </li>
        <li>
            <input id='tzTran' type='checkbox'/> Convert times to registred timezone
        </li>
    </ul>
</div>
<div id='table-section'>

</div>

<script>
    tablesection = document.getElementById('table-section')
    var jsonArray = JSON.parse('{{ split | safe}}');
    tHTML = ''
    for(var k in jsonArray['split_days']){
        console.log(jsonArray['split_days'][k])
        n = 0
        var cHTML = ''
        var tWorked = 0
        cHTML += '<p class = "datetime">' + k + '</p>' +
            '<div class = "timetable">' +
            '<table>' + 
            '<tr>' + 
            '<th>Started</th>' + 
            '<th>Ended</th>' + 
            '<th class = "worked">Time Worked</th>' +
            '</tr>'
        for(var i in jsonArray['split_days'][k]){
            if((n % 2) == 0){
                var regexDate = /\[(.*?)\]\[(.*?)\](\d{4}(-\d{2}){2})T/
                var regexBrackets = /\[(.*?)\]\[(.*?)\]/
                var regexTz = /[+-](\d{4})/
                
                strm1 = jsonArray['split_days'][k][n].replace(regexDate, '')
                strm2 = jsonArray['split_days'][k][n + 1].replace(regexDate, '')
                
                dt1 = jsonArray['split_days'][k][n].replace(regexBrackets, '')
                dt2 = jsonArray['split_days'][k][n + 1].replace(regexBrackets, '')
                dt1 = dt1.replace(regexTz, '')
                dt2 = dt2.replace(regexTz, '')
                var d1 = new Date(dt1)
                var d2 = new Date(dt2)
                var worked = new Date(d2.getTime() - d1.getTime())
                cHTML += '<tr>' + 
                    '<td class = "center-text timeconvert">' + strm1 + '</td>' +
                    '<td class = "center-text timeconvert">' + strm2 + '</td>' +
                    '<td class = "center-text worked">' + writeUTCtime(worked) + '</td>' + 
                    '</tr>'
                tWorked += worked.getTime()
            }
            n++
        }
        cHTML += '</table>' +
            '<table>' + 
            '<tr>' + 
            '<td class = "right-left double-size-table">Time worked this day</td>' + 
            '<td class = "center-text worked">' + writeUTCtime(new Date(tWorked)) + '</td>' +
            '</tr>' +
            '</table>' +
            '</div>'
        tHTML += cHTML
    }

    cHTML += '<div class = "totalwork">' +
            '<table>' + 
            '<tr>' + 
            '<td class = "right-left double-size-table">Total time worked</td>' + 
            '<td class = "center-text worked">' + jsonArray['total_time_worked'] + '</td>' +
            '</tr>' + 
            '</table>' +
            '</div>'
        
    tHTML += cHTML
    tablesection.innerHTML = tHTML
 
    function writeUTCtime(date){
        var hour = addZeroBefore(date.getUTCHours())
        var min = addZeroBefore(date.getUTCMinutes())
        var seconds = addZeroBefore(date.getUTCSeconds())
        return hour + ':' + min  + ':' + seconds
    }

    function addZeroBefore(n) {
        return (n < 10 ? '0' : '') + n;
    }
</script>
<script src="{{ url_for('static',filename='js/main.js') }}"></script>
{% endblock %}