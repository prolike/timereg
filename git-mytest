#!/usr/bin/env python3
import sys
import os
#import platform
import webbrowser
import argparse
import subprocess
import logging as log


def main():
    global location, gitpath, variables

    arguments()

    location = os.getcwd()
    gitpath = find_git(location)
    variables = get_git_variables()

    if args.verbose:
        log.basicConfig(format="%(levelname)s: %(message)s", level=log.DEBUG)
    else:
        log.basicConfig(format="%(levelname)s: %(message)s")        
    if args.web:
        web()

    log.info(location)
    log.info(gitpath)
    log.info(variables)

    ''' lOG ORDER
    log.debug("This is debug") #USE THIS FOR VERBOSE
    log.info("This is info")
    log.warning("This is warning")
    log.error("This is error")
    '''

def arguments():
    global args
    parser = argparse.ArgumentParser(prog="Git extension POC")
    parser.add_argument("-w", "--web", action="store_true", help="Opens the git repository in your browser.")
    parser.add_argument("-v", "--verbose", action="store_true", help="Outputs verbose data")
    args = parser.parse_args()

def find_git(path):
    if os.path.isdir(path + "/.git/"):
        return path + "/.git/"
    else:
        strlist = path.split('/')
        newpath = "/".join(strlist[:-1])
        return find_git(newpath)

def get_git_variables():
    variables_temp = {}
    branch = subprocess.run(["git", "rev-parse", "--abbrev-ref", "HEAD", "--"], stdout=subprocess.PIPE)
    url = subprocess.run(["git", "config", "--get", "remote.origin.url"], stdout=subprocess.PIPE)
    variables_temp["branch"] = branch.stdout.decode("utf-8").rstrip()[:-3]
    variables_temp["url"] = url.stdout.decode("utf-8").rstrip()
    return variables_temp

def web():
    if variables["url"][:4] == "git@":
        link = "github.com/" + variables["url"].split(":")[-1][:-4]
    else:
        link = variables["url"][:-4]
    log.debug("webbrowser.open " + link)
    webbrowser.open(link, new=0, autoraise=True)

if __name__ == "__main__":
    main()